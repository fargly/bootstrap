---
- name: Bootstrap local development environment
  hosts: 127.0.0.1
  connection: local
  tasks:
    - name: Update cache and upgrade packages using generic package manager
      become: true
      ansible.builtin.package:
        upgrade: true
        update_cache: true
      tags: privileged
      when: not ansible_os_family == 'Darwin'

    - name: Install packages
      become: true
      ansible.builtin.package:
        name: "{{ packages }}"
      vars:
        packages:
          - bash-completion
          - binutils
          - dnsutils
          - htop
          - tmux
          - unzip
      tags: privileged
      when: not ansible_os_family == 'Darwin'

    - name: "This task only runs on macOS"
      ansible.builtin.debug:
        msg: "This is a macOS-specific task!"
      when: ansible_os_family == 'Darwin'

    ## Ensure .local/bin Directory Exists
    - name: Ensure ~/.local/bin directory
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.local/bin"
        state: directory
        mode: "0755"

    ## Ensure .local/opt Directory Exists
    - name: Ensure ~/.local/opt directory
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.local/opt"
        state: directory
        mode: "0755"

    - name: Clone Fargly's Bootstrap Repository
      ansible.builtin.git:
        repo: https://github.com/fargly/bootstrap.git
        dest: "{{ ansible_env.HOME }}/.local/opt/bootstrap"
      # noqa: latest

    ## Create Local uvx based Ansible Tooling
    - name: Create ansible-playbook script
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/.local/bin/ansible-playbook"
        content: |
          #!/usr/bin/env bash
          ## uvx based Ansible Playbook Launcher v0.1 20250724

          #uvx --from ansible-core ansible-playbook --ask-become-pass
          uvx --from ansible-core ansible-playbook  --skip-tags "privileged" $@

          ## EOF
        mode: "0755"

    - name: Create ansible-playbook-privilege script
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/.local/bin/ansible-playbook-privilege"
        content: |
          #!/usr/bin/env bash
          ## uvx based Ansible Playbook Launcher v0.1 20250724

          #uvx --from ansible-core ansible-playbook
          uvx --from ansible-core ansible-playbook --ask-become-pass $@

          ## EOF
        mode: "0755"

    - name: Create ansible-vault script
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/.local/bin/ansible-vault"
        content: |
          #!/usr/bin/env bash
          ## uvx based Ansible Vault Launcher v0.1 20250724

          #uvx --from ansible-core ansible-playbook --ask-become-pass
          #uvx --from ansible-core ansible-playbook  --skip-tags "privileged" $@
          ## Note: You may need to add '--ask-vault-pass' in bootstrapping mode
          uvx --from ansible-core ansible-vault $@

          ## EOF
        mode: "0755"

    - name: Remove the env file line
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        regexp: '^.*/.local/bin/env.*$'
        state: absent

    - name: Add basic bashrc items
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        line: |

          set -o vi
          export EDITOR=vim

        state: present
