---
- name: Bootstrap local development environment
  hosts: 127.0.0.1
  connection: local

  tasks:

    ## macOS/Darwin Specific Tasks
    - name: Ensure Homebrew is installed
      ansible.builtin.shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      args:
        creates: /opt/homebrew/bin/brew
      become: false
      when: ansible_os_family == 'Darwin'
      tags:
        - setup

    - name: Install specified Homebrew packages
      community.general.homebrew:
        name:
          - bash-completion
          - binutils
          - htop
          - tmux
          - unzip
          - git
          - gnu-tar
        state: present
        update_homebrew: true
      become: false
      when: ansible_os_family == 'Darwin'
      tags:
        - packages

    - name: Find the username for UID 501
      ansible.builtin.command: dscl . -search /Users UniqueID 501
      register: user_info
      changed_when: false # This is a lookup command, not a change
      when: ansible_os_family == 'Darwin'

    - name: Extract username from command output
      ansible.builtin.set_fact:
        target_user: "{{ user_info.stdout | regex_search('^\\S+') }}"
      when: ansible_os_family == 'Darwin'

    # - name: Set the user's shell to bash
    #   ansible.builtin.user:
    #     name: "{{ target_user }}"
    #     shell: /bin/bash
    #   when: target_user is defined and target_user | length > 0 and ansible_os_family == 'Darwin'
