---
- name: Bootstrap local development environment
  hosts: 127.0.0.1
  connection: local
  tasks:
    - name: Update cache and upgrade packages using generic package manager
      become: true
      ansible.builtin.package:
        upgrade: true
        update_cache: true
      tags: privileged
      when: not ansible_os_family == 'Darwin'

    - name: Install packages
      become: true
      ansible.builtin.package:
        name: "{{ packages }}"
      vars:
        packages:
          - bash-completion
          - binutils
          - dnsutils
          - htop
          - tmux
          - unzip
      tags: privileged
      when: not ansible_os_family == 'Darwin'

    - name: Check if the community.general collection is already installed
      ansible.builtin.command:
        cmd: ansible-galaxy collection list | grep community.general
      register: collection_check
      failed_when: false # Prevents the play from failing if the collection isn't found
      changed_when: false # This is a check, not a change

    - name: Ensure the community.general collection is installed
      ansible.builtin.command: "{{ ansible_env.HOME }}/.local/bin/uvx --from ansible-core ansible-galaxy collection install community.general"
        #   args:
        #     # Prevents Ansible from re-running this task if the collection is already installed.
        #     # This is a basic form of idempotency.
        #     creates: "{{ ansible_env.HOME }}/.ansible/collections/ansible_collections/community/general"
      changed_when: false # This is a check, not a change
      when: collection_check.stdout == ''

    ## macOS/Darwin Specific Tasks
    - name: Ensure Homebrew is installed
      ansible.builtin.shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      args:
        creates: /opt/homebrew/bin/brew
      become: false
      when: ansible_os_family == 'Darwin'
      tags:
        - setup

    - name: Install specified Homebrew packages
      community.general.homebrew:
        name:
          - bash-completion
          - binutils
          - htop
          - tmux
          - unzip
          - git
          - gnu-tar
        state: present
        update_homebrew: true
      become: false
      when: ansible_os_family == 'Darwin'
      tags:
        - packages

    - name: Find the username for UID 501
      ansible.builtin.command: dscl . -search /Users UniqueID 501
      register: user_info
      changed_when: false # This is a lookup command, not a change
      when: ansible_os_family == 'Darwin'

    - name: Extract username from command output
      ansible.builtin.set_fact:
        target_user: "{{ user_info.stdout | regex_search('^\\S+') }}"
      when: ansible_os_family == 'Darwin'

    # - name: Set the user's shell to bash
    #   ansible.builtin.user:
    #     name: "{{ target_user }}"
    #     shell: /bin/bash
    #   when: target_user is defined and target_user | length > 0 and ansible_os_family == 'Darwin'

    ## Ensure .local/bin Directory Exists
    - name: Ensure ~/.local/bin directory
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.local/bin"
        state: directory
        mode: "0755"

    ## Ensure .local/opt Directory Exists
    - name: Ensure ~/.local/opt directory
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.local/opt"
        state: directory
        mode: "0755"

    - name: Clone Fargly's Bootstrap Repository
      ansible.builtin.git:
        repo: https://github.com/fargly/bootstrap.git
        dest: "{{ ansible_env.HOME }}/.local/opt/bootstrap"
      # noqa: latest

    ## Create Local uvx based Ansible Tooling
    - name: Create ansible-playbook script
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/.local/bin/ansible-playbook"
        content: |
          #!/usr/bin/env bash
          ## uvx based Ansible Playbook Launcher v0.1 20250724

          #uvx --from ansible-core ansible-playbook --ask-become-pass
          uvx --from ansible-core ansible-playbook  --skip-tags "privileged" $@

          ## EOF
        mode: "0755"

    - name: Create ansible-playbook-privilege script
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/.local/bin/ansible-playbook-privilege"
        content: |
          #!/usr/bin/env bash
          ## uvx based Ansible Playbook Launcher v0.1 20250724

          #uvx --from ansible-core ansible-playbook
          uvx --from ansible-core ansible-playbook --ask-become-pass $@

          ## EOF
        mode: "0755"

    - name: Create ansible-vault script
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/.local/bin/ansible-vault"
        content: |
          #!/usr/bin/env bash
          ## uvx based Ansible Vault Launcher v0.1 20250724

          #uvx --from ansible-core ansible-playbook --ask-become-pass
          #uvx --from ansible-core ansible-playbook  --skip-tags "privileged" $@
          ## Note: You may need to add '--ask-vault-pass' in bootstrapping mode
          uvx --from ansible-core ansible-vault $@

          ## EOF
        mode: "0755"

    - name: Create ansible-galaxy script
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/.local/bin/ansible-galaxy"
        content: |
          #!/usr/bin/env bash
          ## uvx based Ansible Galaxy Launcher v0.1 20250724

          # uvx --from ansible-core ansible-galaxy  --skip-tags "privileged" $@
          uvx --from ansible-core ansible-galaxy $@

          ## EOF
        mode: "0755"

    - name: Remove the env file line
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        create: true
        mode: "0755"
        regexp: '^.*/.local/bin/env.*$'
        state: absent

    - name: Add basic bashrc items
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        create: true
        mode: "0755"
        insertafter: EOF
        line: |

          set -o vi
          export EDITOR=vim
          PATH="$HOME/.local/bin:$PATH"
          export PATH

        state: present
