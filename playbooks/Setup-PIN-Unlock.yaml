---
- name: Setup PIN Unlock
  hosts: localhost
  gather_facts: true

  vars_files:
    - "{{ playbook_dir }}/../data/secrets.yaml.vault"

  tasks:
    - name: Update cache and upgrade packages using generic package manager
      become: true
      ansible.builtin.package:
        upgrade: true
        update_cache: true
      tags: privileged
      when: not ansible_facts["os_family"] == 'Darwin'

    - name: Install packages
      become: true
      ansible.builtin.package:
        name: "{{ packages }}"
      vars:
        packages:
          - libpam-pwdfile
          - whois
      tags: privileged
      when: not ansible_facts["os_family"] == 'Darwin'

    - name: Write PIN Password to file
      become: true
      ansible.builtin.copy:
        content: "{{ Desktop_PIN_Entry }}"
        dest: "/etc/custompinfile"
        mode: '0600'
      no_log: true

    - name: Ensure line is present after specified string
      become: true
      vars:
        option_line: "auth sufficient pam_pwdfile.so pwdfile=/etc/custompinfile"
      ansible.builtin.blockinfile:
        path: /etc/pam.d/gdm-password
        insertafter: '#%PAM-1.0'
        block: "{{ option_line }}"
